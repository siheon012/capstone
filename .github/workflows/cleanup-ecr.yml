name: ECR Image Cleanup

on:
  push: # <--- ì´ ë¶€ë¶„ ì¶”ê°€!
    branches: [ECSFargate]
  schedule:
    - cron: '0 18 * * 6' # KST ì¼ìš”ì¼ 03:00 (UTC í† ìš”ì¼ 18:00)
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}
  ECR_BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
  ECR_BATCH_REPO: ${{ secrets.ECR_BATCH_REPO }}

jobs:
  cleanup-ecr:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup Untagged Images
        run: |
          # Untagged ì´ë¯¸ì§€ëŠ” ì¦‰ì‹œ ì‚­ì œ (ìŠ¤í† ë¦¬ì§€ ë‚­ë¹„ ë°©ì§€)
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ðŸ” Checking untagged images in $REPO..."
            
            # ì‚­ì œ ëŒ€ìƒ ì´ë¯¸ì§€ ID ì¶”ì¶œ (JSON í˜•íƒœ)
            IMAGES=$(aws ecr list-images \
              --repository-name $REPO \
              --filter "tagStatus=UNTAGGED" \
              --query 'imageIds[*]' \
              --output json)

            # ì‚­ì œí•  ì´ë¯¸ì§€ê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸ (ë¹ˆ ë°°ì—´ì´ ì•„ë‹ˆê³  nullì´ ì•„ë‹ ë•Œ)
            if [ "$IMAGES" != "[]" ] && [ "$IMAGES" != "null" ] && [ ! -z "$IMAGES" ]; then
              echo "ðŸ—‘ï¸ Deleting untagged images from $REPO..."
              aws ecr batch-delete-image \
                --repository-name $REPO \
                --image-ids "$IMAGES"
              echo "âœ… Untagged images cleanup completed for $REPO"
            else
              echo "âœ¨ No untagged images found in $REPO"
            fi
          done

      - name: Cleanup Old Tagged Images (Keep last 10)
        run: |
          # ìµœì‹  10ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì‚­ì œ
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ðŸ” Checking old images in $REPO (keeping last 10)..."
            
            # ë‚ ì§œìˆœ ì •ë ¬ í›„ ìµœì‹  10ê°œë¥¼ ì œì™¸í•œ Digest ì¶”ì¶œ
            OLD_IMAGES_JSON=$(aws ecr describe-images \
              --repository-name $REPO \
              --query 'sort_by(imageDetails,& imagePushedAt)[:-10].imageDigest' \
              --output json)
            
            # ì‚­ì œí•  ì´ë¯¸ì§€ê°€ ìžˆëŠ”ì§€ í™•ì¸
            if [ "$OLD_IMAGES_JSON" != "[]" ] && [ "$OLD_IMAGES_JSON" != "null" ]; then
              # Digest ë¦¬ìŠ¤íŠ¸ë¥¼ batch-delete-image í¬ë§·({imageDigest: ...})ìœ¼ë¡œ ë³€í™˜
              IDS=$(echo "$OLD_IMAGES_JSON" | jq -c '[.[] | {imageDigest: .}]')
              
              if [ "$IDS" != "[]" ]; then
                echo "ðŸ—‘ï¸ Deleting older images from $REPO..."
                aws ecr batch-delete-image \
                  --repository-name $REPO \
                  --image-ids "$IDS"
                echo "âœ… Old images cleanup completed for $REPO"
              else
                echo "âœ¨ No old images to delete in $REPO"
              fi
            else
              echo "âœ¨ No old images to delete in $REPO"
            fi
          done

      - name: Report Storage Saved
        if: always()
        run: |
          echo "### ðŸ“Š ECR Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Remaining Images |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY

          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            TOTAL=$(aws ecr describe-images --repository-name $REPO --query 'length(imageDetails)' --output text)
            echo "| $REPO | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’° **Estimated monthly savings:** ~$2-5 USD" >> $GITHUB_STEP_SUMMARY
