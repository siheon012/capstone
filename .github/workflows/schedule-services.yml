name: AWS Services Scheduler (ECS + RDS)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST 08:00 = UTC ì „ë‚  23:00) - ì„œë¹„ìŠ¤ ì¤‘ì§€
    - cron: '0 23 * * *'
    # ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST 14:00 = UTC 05:00) - ì„œë¹„ìŠ¤ ì‹œìž‘
    - cron: '0 5 * * *'
    # ë§¤ì£¼ í† ìš”ì¼ ì˜¤ì „ 10ì‹œ (7ì¼ ìžë™ ì‹œìž‘ ë°©ì§€)
    - cron: '0 1 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.ECS_CLUSTER }}
  FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}
  BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}

jobs:
  schedule-ecs:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine action
        id: determine-action
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
          else
            # Cron ê¸°ë°˜ ìžë™ ì‹¤í–‰ ë¡œì§
            HOUR=$(date -u +%H)
            
            # UTC 23:00 (KST 08:00) -> STOP
            if [ "$HOUR" == "23" ]; then
              ACTION="stop"
            # UTC 05:00 (KST 14:00) -> START
            elif [ "$HOUR" == "05" ]; then
              ACTION="start"
            # í† ìš”ì¼ 01:00 (KST 10:00) -> CYCLE (7ì¼ ë°©ì§€)
            elif [ "${{ github.event.schedule }}" == "0 1 * * 6" ]; then
              ACTION="cycle"
            else
              ACTION="status"
            fi
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Action determined: $ACTION"

      - name: Get current status
        id: status
        run: |
          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text 2>/dev/null || echo "not-found")

          echo "rds_status=$RDS_STATUS" >> $GITHUB_OUTPUT

      # [STOP] ì„œë¹„ìŠ¤ ì¤‘ì§€
      - name: Stop Services (save costs)
        if: steps.determine-action.outputs.action == 'stop'
        run: |
          echo "ðŸ›‘ Stopping ECS services..."
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 0
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 0

          echo "ðŸ›‘ Stopping RDS instance..."
          if [ "${{ steps.status.outputs.rds_status }}" == "available" ]; then
            aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "âœ… RDS stop initiated."
          else
            echo "â„¹ï¸ RDS is already stopped or not available ($RDS_STATUS)."
          fi

      # [CYCLE] 7ì¼ ìžë™ ì‹œìž‘ ë°©ì§€ (í† ìš”ì¼)
      - name: Prevent RDS 7-day auto-restart
        if: steps.determine-action.outputs.action == 'cycle'
        run: |
          echo "ðŸ”„ Running weekly cycle to reset 7-day timer..."

          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "â³ RDS starting... waiting 3 minutes before stopping again."
            sleep 180 
            aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "âœ… RDS cycle complete."
          else
            echo "â„¹ï¸ RDS is not stopped, skipping cycle."
          fi

      # [START] ì„œë¹„ìŠ¤ ì‹œìž‘
      - name: Start Services
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "ðŸš€ Starting Services..."

          # RDS ë¨¼ì € ì‹œìž‘
          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "â³ Waiting for RDS to become available..."
            aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
          fi

          # ECS ì‹œìž‘
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 1
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 1

          echo "â³ Waiting for ECS services to stabilize..."
          aws ecs wait services-stable --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.FRONTEND_SERVICE }} ${{ env.BACKEND_SERVICE }}
          echo "âœ… All services started successfully."

      # ìµœì¢… ìƒíƒœ ë¦¬í¬íŠ¸ (í•­ìƒ ì‹¤í–‰)
      - name: Generate status summary
        if: always()
        run: |
          echo "### ðŸ“Š Final Status Report" >> $GITHUB_STEP_SUMMARY
          echo "**Action Performed:** ${{ steps.determine-action.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp (KST):** $(TZ=Asia/Seoul date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FRONTEND_COUNT=$(aws ecs describe-services --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.FRONTEND_SERVICE }} --query 'services[0].desiredCount' --output text)
          BACKEND_COUNT=$(aws ecs describe-services --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.BACKEND_SERVICE }} --query 'services[0].desiredCount' --output text)
          RDS_STATUS=$(aws rds describe-db-instances --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null || echo "unknown")

          echo "| Service | Status / Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Frontend | $FRONTEND_COUNT tasks |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend | $BACKEND_COUNT tasks |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ RDS | $RDS_STATUS |" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_COUNT" == "0" ] && [ "$BACKEND_COUNT" == "0" ] && [ "$RDS_STATUS" == "stopped" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’° **All services stopped - Maximizing savings!**" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND_COUNT" != "0" ] && [ "$RDS_STATUS" == "available" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŸ¢ **Services running - Ready for traffic**" >> $GITHUB_STEP_SUMMARY
          fi
