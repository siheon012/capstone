name: 'Terraform CI'

on:
  pull_request:
    branches: ['main'] # mainìœ¼ë¡œ ê°€ëŠ” PRì´ ìƒê¸°ë©´ ë°œë™!

permissions:
  contents: read
  pull-requests: write # PRì— ëŒ“ê¸€ì„ ë‹¬ì•„ì•¼ í•´ì„œ ê¶Œí•œ í•„ìš”í•¨

jobs:
  terraform:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./terraform # main.tfê°€ ìˆëŠ” í´ë” ê²½ë¡œ (ì¤‘ìš”!)

    steps:
      # 1. ë‚´ ì½”ë“œ ë‚´ë ¤ë°›ê¸°
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Terraform ì„¤ì¹˜
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0 # ì‚¬ìš© ì¤‘ì¸ ë²„ì „ê³¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶¤

      # 3. AWS ìê²© ì¦ëª… ì„¤ì • (ì•„ê¹Œ ë“±ë¡í•œ Secret ì‚¬ìš©)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 4. ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ë“¤ì—¬ì“°ê¸° ì—‰ë§ì´ë©´ ì—¬ê¸°ì„œ íƒˆë½)
      - name: Terraform Format
        run: terraform fmt -check

      # 5. ì´ˆê¸°í™” (S3 Backend ì—°ê²°)
      - name: Terraform Init
        run: terraform init

      # 6. ë³€ê²½ ì‚¬í•­ ì˜ˆì¸¡ (Plan) - ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ì§€ ì•Šê³  í™”ë©´ì— ì¶œë ¥
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        continue-on-error: true # Planì´ ì‹¤íŒ¨í•´ë„(ë³€ê²½ì‚¬í•­ ìˆì–´ë„) ì¼ë‹¨ ë‹¤ìŒ ë‹¨ê³„ë¡œ

      # 7. PRì— ëŒ“ê¸€ ë‹¬ê¸° (ì—¬ê¸°ê°€ í•˜ì´ë¼ì´íŠ¸! âœ¨)
      - name: Update Pull Request
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### ğŸ–Œ Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### âš™ï¸ Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
            #### ğŸ“– Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
