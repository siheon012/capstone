name: ğŸ§¹ ECR Image Cleanup

on:
  schedule:
    - cron: '0 18 * * 6' # KST ì¼ìš”ì¼ 03:00
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}
  ECR_BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
  ECR_BATCH_REPO: ${{ secrets.ECR_BATCH_REPO }}

jobs:
  cleanup-ecr:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup Untagged Images
        run: |
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ğŸ” Checking untagged images in $REPO..."
            
            # íƒœê·¸ ì—†ëŠ” ì´ë¯¸ì§€ë“¤ì˜ Digest ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            IMAGES=$(aws ecr list-images \
              --repository-name $REPO \
              --filter "tagStatus=UNTAGGED" \
              --query 'imageIds[*]' \
              --output json)

            if [ "$IMAGES" != "[]" ] && [ ! -z "$IMAGES" ]; then
              echo "ğŸ—‘ï¸ Deleting untagged images from $REPO..."
              aws ecr batch-delete-image \
                --repository-name $REPO \
                --image-ids "$IMAGES"
            else
              echo "âœ¨ No untagged images found in $REPO"
            fi
          done

      - name: Cleanup Old Tagged Images (Keep last 10)
        run: |
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ğŸ” Cleaning old images from $REPO (keeping last 10)..."
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ 10ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ Digest ëª©ë¡ ì¶”ì¶œ (ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜)
            OLD_IMAGES_JSON=$(aws ecr describe-images \
              --repository-name $REPO \
              --query 'sort_by(imageDetails,& imagePushedAt)[:-11].imageDigest' \
              --output json)
            
            # ì‚­ì œí•  ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
            if [ "$OLD_IMAGES_JSON" != "[]" ] && [ "$OLD_IMAGES_JSON" != "null" ]; then
              # Digest ë¦¬ìŠ¤íŠ¸ë¥¼ batch-delete-imageê°€ ìš”êµ¬í•˜ëŠ” JSON êµ¬ì¡°(imageDigest=...)ë¡œ ë³€í™˜
              IDS=$(echo "$OLD_IMAGES_JSON" | jq -c '[.[] | {imageDigest: .}]')
              
              echo "ğŸ—‘ï¸ Deleting older images from $REPO..."
              aws ecr batch-delete-image \
                --repository-name $REPO \
                --image-ids "$IDS"
              echo "âœ… Old images cleanup completed"
            else
              echo "âœ¨ No old images to delete in $REPO"
            fi
          done

      - name: Report Storage Saved
        run: |
          echo "ğŸ“Š ECR Cleanup Summary"
          echo "======================"
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            TOTAL=$(aws ecr describe-images --repository-name $REPO --query 'length(imageDetails)' --output text)
            echo "$REPO: $TOTAL images remaining"
          done
