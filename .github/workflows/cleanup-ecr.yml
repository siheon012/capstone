name: 'ECR Image Cleanup'

on:
  push:
    branches: [ECSFargate]
  schedule:
    - cron: '0 18 * * 6' # KST ì¼ìš”ì¼ 03:00 (UTC í† ìš”ì¼ 18:00)
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}
  ECR_BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
  ECR_BATCH_REPO: ${{ secrets.ECR_BATCH_REPO }}

jobs:
  cleanup-ecr:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup Untagged Images
        run: |
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ðŸ” Checking untagged images in $REPO..."
            
            # Untagged ì´ë¯¸ì§€ì˜ Digest ì¶”ì¶œ (Text í¬ë§·)
            DIGESTS=$(aws ecr list-images \
              --repository-name $REPO \
              --filter "tagStatus=UNTAGGED" \
              --query 'imageIds[*].imageDigest' \
              --output text)

            if [ -n "$DIGESTS" ]; then
              echo "ðŸ—‘ï¸ Deleting untagged images from $REPO..."
              
              # [ì¤‘ìš”] 100ê°œì”© ëŠì–´ì„œ ì‚­ì œ (xargs í™œìš©)
              echo "$DIGESTS" | tr '\t' '\n' | while read digest; do
                echo "imageDigest=$digest"
              done | xargs -n 100 aws ecr batch-delete-image --repository-name $REPO --region ${{ env.AWS_REGION }} --image-ids

              echo "âœ… Untagged images cleanup completed for $REPO"
            else
              echo "âœ¨ No untagged images found in $REPO"
            fi
          done

      - name: Cleanup Old Tagged Images (Keep last 10)
        run: |
          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            echo "ðŸ” Checking old images in $REPO (keeping last 10)..."
            
            # ìµœì‹  10ê°œë¥¼ ì œì™¸í•œ ì˜¤ëž˜ëœ ì´ë¯¸ì§€ Digest ì¶”ì¶œ (Text í¬ë§·)
            OLD_DIGESTS=$(aws ecr describe-images \
              --repository-name $REPO \
              --query 'sort_by(imageDetails,& imagePushedAt)[:-10].imageDigest' \
              --output text)
            
            if [ -n "$OLD_DIGESTS" ]; then
               echo "ðŸ—‘ï¸ Deleting older images from $REPO..."

               # [ì¤‘ìš”] 100ê°œì”© ëŠì–´ì„œ ì‚­ì œ
               echo "$OLD_DIGESTS" | tr '\t' '\n' | while read digest; do
                 echo "imageDigest=$digest"
               done | xargs -n 100 aws ecr batch-delete-image --repository-name $REPO --region ${{ env.AWS_REGION }} --image-ids

               echo "âœ… Old images cleanup completed for $REPO"
            else
              echo "âœ¨ No old images to delete in $REPO"
            fi
          done

      - name: Report Storage Saved
        if: always()
        run: |
          echo "### ECR Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Remaining Images |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY

          for REPO in ${{ env.ECR_FRONTEND_REPO }} ${{ env.ECR_BACKEND_REPO }} ${{ env.ECR_BATCH_REPO }}; do
            TOTAL=$(aws ecr describe-images --repository-name $REPO --query 'length(imageDetails)' --output text)
            echo "| $REPO | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’° **Estimated monthly savings:** ~$2-5 USD" >> $GITHUB_STEP_SUMMARY
