name: Deploy to Production

on:
  push:
    branches: [ECSFargate]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}
  ECR_BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}
  ECS_BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  CLOUDWATCH_FRONTEND_LOG_GROUP: /ecs/${{ secrets.ECR_FRONTEND_REPO }}
  CLOUDWATCH_BACKEND_LOG_GROUP: /ecs/${{ secrets.ECR_BACKEND_REPO }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ 2ê°œ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°

      # 1.5 ë³€ê²½ëœ ì½”ë“œ Diff ìˆ˜ì§‘
      - name: Collect code changes
        id: git-diff
        run: |
          echo "collecting-diff" > /tmp/diff_status.txt
          
          # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git diff HEAD~1 HEAD > /tmp/code_changes.diff
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Code changes collected ($(wc -l < /tmp/code_changes.diff) lines)"
          else
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No previous commit to compare"
          fi

      # 2. AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3.5 Docker ë¹Œë“œ ìºì‹œ ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 3.6 AWS Account ID ê°€ì ¸ì˜¤ê¸°
      - name: Get AWS Account ID
        id: account
        run: |
          echo "AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV

      # 4. Frontend ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building frontend with commit SHA: $IMAGE_TAG"

          # í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ (cache ì‚¬ìš©)
          docker buildx build --target production \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest \
            --push \
            ./front

          # ìºì‹œ êµì²´ (ë¬´í•œ ì¦ê°€ ë°©ì§€)
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

          echo "Frontend image pushed successfully!"

      # 5. Backend ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building backend with commit SHA: $IMAGE_TAG"

          # Backend ì´ë¯¸ì§€ ë¹Œë“œ (cache ì‚¬ìš©)
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest \
            --push \
            ./back

          # ìºì‹œ êµì²´
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

          echo "Backend image pushed successfully!"

      # 6. ECS ì„œë¹„ìŠ¤ ë°°í¬
      - name: Deploy Frontend to ECS
        id: deploy-frontend
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Deploying frontend with image tag: $IMAGE_TAG"
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_FRONTEND_SERVICE }} \
            --force-new-deployment \
            --deployment-configuration "deploymentCircuitBreaker={enable=true,rollback=true}" \
            --region ${{ env.AWS_REGION }}
          
          echo "frontend_deployed=true" >> $GITHUB_OUTPUT

      - name: Deploy Backend to ECS
        id: deploy-backend
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Deploying backend with image tag: $IMAGE_TAG"
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_BACKEND_SERVICE }} \
            --force-new-deployment \
            --deployment-configuration "deploymentCircuitBreaker={enable=true,rollback=true}" \
            --region ${{ env.AWS_REGION }}
          
          echo "backend_deployed=true" >> $GITHUB_OUTPUT

      # 7. ë°°í¬ ì•ˆì •ì„± í™•ì¸
      - name: Wait for deployment stability
        if: success()
        run: |
          echo "â³ Waiting for services to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ… Deployment stable"

      # 8. ë°°í¬ ì„±ê³µ Summary
      - name: Generate Deployment Summary
        if: success()
        run: |
          echo "# ğŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY

      # 9. ë°°í¬ ì‹¤íŒ¨ ì‹œ ì¥ì•  ë¶„ì„
      - name: Collect failure diagnostics
        if: failure()
        id: diagnostics
        run: |
          echo "ğŸ” Collecting deployment failure diagnostics..."
          
          # Frontend íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸
          FRONTEND_TASKS=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_FRONTEND_SERVICE }} \
            --desired-status STOPPED \
            --max-results 5 \
            --region ${{ env.AWS_REGION }} \
            --query 'taskArns[0]' \
            --output text)
          
          if [ "$FRONTEND_TASKS" != "None" ] && [ ! -z "$FRONTEND_TASKS" ]; then
            FRONTEND_REASON=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $FRONTEND_TASKS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0].stoppedReason' \
              --output text)
            echo "frontend_stop_reason=$FRONTEND_REASON" >> $GITHUB_OUTPUT
          fi
          
          # Backend íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸
          BACKEND_TASKS=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_BACKEND_SERVICE }} \
            --desired-status STOPPED \
            --max-results 5 \
            --region ${{ env.AWS_REGION }} \
            --query 'taskArns[0]' \
            --output text)
          
          if [ "$BACKEND_TASKS" != "None" ] && [ ! -z "$BACKEND_TASKS" ]; then
            BACKEND_REASON=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $BACKEND_TASKS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0].stoppedReason' \
              --output text)
            echo "backend_stop_reason=$BACKEND_REASON" >> $GITHUB_OUTPUT
          fi
          
          # CloudWatch ë¡œê·¸ ìˆ˜ì§‘ (ìµœê·¼ 50ì¤„)
          FRONTEND_LOGS=$(aws logs tail ${{ env.CLOUDWATCH_FRONTEND_LOG_GROUP }} --since 10m --format short 2>/dev/null | tail -50 || echo "No logs available")
          BACKEND_LOGS=$(aws logs tail ${{ env.CLOUDWATCH_BACKEND_LOG_GROUP }} --since 10m --format short 2>/dev/null | tail -50 || echo "No logs available")
          
          # ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          echo "$FRONTEND_LOGS" > /tmp/frontend_logs.txt
          echo "$BACKEND_LOGS" > /tmp/backend_logs.txt
          
          echo "has_diagnostics=true" >> $GITHUB_OUTPUT

      # 10. Bedrockìœ¼ë¡œ ë¡œê·¸ ìš”ì•½
      - name: Summarize logs with Bedrock
        if: failure()
        id: bedrock-summary
        run: |
          echo "ğŸ¤– Summarizing logs with AWS Bedrock..."
          
          FRONTEND_LOGS=$(cat /tmp/frontend_logs.txt 2>/dev/null || echo "No frontend logs")
          BACKEND_LOGS=$(cat /tmp/backend_logs.txt 2>/dev/null || echo "No backend logs")
          CODE_DIFF=$(cat /tmp/code_changes.diff 2>/dev/null || echo "No code changes available")
          
          # Bedrock í”„ë¡¬í”„íŠ¸ êµ¬ì„± (Git Diff í¬í•¨)
          PROMPT="You are a DevOps engineer analyzing deployment failure logs. Summarize the root cause in Korean using this template:

## ë°°í¬ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„

**í•µì‹¬ ì›ì¸:** [í•œ ì¤„ ìš”ì•½]

**ìƒì„¸ ë¶„ì„:**
- ë°œìƒ ì‹œê°: [íƒ€ì„ìŠ¤íƒ¬í”„]
- ì˜í–¥ ë²”ìœ„: [Frontend/Backend/Both]
- ì—ëŸ¬ íƒ€ì…: [ì˜ˆ: Container Exit, Network Error, Database Connection]

**ë³€ê²½ëœ ì½”ë“œ ë¶„ì„:**
(Code diff below)

**ë¡œê·¸ ì¦ê±°:**
(Error logs below)

**ê¶Œì¥ ì¡°ì¹˜:**
1. [ì¦‰ì‹œ í•´ì•¼ í•  ê²ƒ]
2. [ê·¼ë³¸ ì›ì¸ í•´ê²° ë°©ë²•]

---

Code Changes (This deployment):
$CODE_DIFF

Frontend Logs:
$FRONTEND_LOGS

Backend Logs:
$BACKEND_LOGS"
          
          # Bedrock API í˜¸ì¶œ
          SUMMARY=$(aws bedrock-runtime invoke-model \
            --model-id anthropic.claude-3-sonnet-20240229-v1:0 \
            --body "{\"anthropic_version\":\"bedrock-2023-05-31\",\"max_tokens\":2000,\"messages\":[{\"role\":\"user\",\"content\":\"$PROMPT\"}]}" \
            --region ${{ env.AWS_REGION }} \
            /tmp/bedrock_response.json 2>/dev/null && \
            cat /tmp/bedrock_response.json | jq -r '.content[0].text' || echo "Bedrock ìš”ì•½ ì‹¤íŒ¨")
          
          # Summaryë¥¼ íŒŒì¼ë¡œ ì €ì¥
          echo "$SUMMARY" > /tmp/bedrock_summary.txt
          echo "summary_created=true" >> $GITHUB_OUTPUT

      # 11. ë°°í¬ ì‹¤íŒ¨ Issue ìë™ ìƒì„±
      - name: Create deployment failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const commit = '${{ github.sha }}'.substring(0, 7);
            
            let summary = "Bedrock ìš”ì•½ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            try {
              summary = fs.readFileSync('/tmp/bedrock_summary.txt', 'utf8');
            } catch (e) {
              summary = `## ë°°í¬ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´
              
**Commit:** ${{ github.sha }}
**Branch:** ${{ github.ref_name }}
**ì‹¤íŒ¨ ì‹œê°:** ${new Date().toISOString()}

**Frontend ì¤‘ì§€ ì›ì¸:** ${{ steps.diagnostics.outputs.frontend_stop_reason || 'N/A' }}
**Backend ì¤‘ì§€ ì›ì¸:** ${{ steps.diagnostics.outputs.backend_stop_reason || 'N/A' }}

### ì›ë³¸ ë¡œê·¸
CloudWatch ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: [AWS Console](https://ap-northeast-2.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-2#logsV2:log-groups)
              `;
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ë°°í¬ ì‹¤íŒ¨ - ${date} (${commit})`,
              body: summary,
              labels: ['deployment', 'failure', 'automated', 'urgent']
            });
