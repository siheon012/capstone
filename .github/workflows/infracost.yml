name: Infracost FinOps Check

on:
  pull_request:
    paths:
      - 'terraform/**' # ğŸ‘ˆ ì£¼ì˜: í…Œë¼í¼ ì½”ë“œê°€ ìˆëŠ” í´ë”ëª…ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”! (ì˜ˆ: infra/** ë˜ëŠ” modules/**)
permissions:
  contents: read
  pull-requests: write # PRì— ëŒ“ê¸€ì„ ë‹¬ì•„ì•¼ í•´ì„œ ê¶Œí•œ í•„ìš”

jobs:
  infracost:
    name: Show Cost Estimate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      # 1. í˜„ì¬ ë©”ì¸ ë¸Œëœì¹˜ì˜ ë¹„ìš© ê³„ì‚° (ê¸°ì¤€ì )
      - name: Generate Infracost cost estimate baseline
        run: |
          infracost breakdown --path=terraform \
            --format=json \
            --out-file=/tmp/infracost-base.json

      # 2. PRë¡œ ë³€ê²½ëœ ì½”ë“œì˜ ë¹„ìš© ê³„ì‚°
      - name: Generate Infracost cost estimate diff
        run: |
          infracost breakdown --path=terraform \
            --format=diff \
            --out-file=/tmp/infracost.json \
            --compare-to=/tmp/infracost-base.json

      # 3. PRì— ëŒ“ê¸€ ë‹¬ê¸°
      - name: Post Infracost comment
        uses: infracost/actions/comment@v3.0.1
        with:
          path: /tmp/infracost.json
          behavior: update # ê¸°ì¡´ ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ìˆ˜ì • (ë„ë°° ë°©ì§€)s
