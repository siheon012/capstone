name: ⏰ AWS Services Scheduler (ECS + RDS)

on:
  schedule:
    # 매일 오전 8시 (KST 08:00 = UTC 전날 23:00) - 서비스 중지
    - cron: '0 23 * * *'
    # 매일 오후 2시 (KST 14:00 = UTC 05:00) - 서비스 시작
    - cron: '0 5 * * *'
    # 매주 토요일 오전 10시 (7일 자동 시작 방지)
    - cron: '0 1 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.ECS_CLUSTER }}
  FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}
  BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}

jobs:
  schedule-ecs:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine action
        id: determine-action
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" == "23" ]; then
              ACTION="stop"
            elif [ "$HOUR" == "05" ]; then
              ACTION="start"
            elif [ "${{ github.event.schedule }}" == "0 1 * * 6" ]; then
              ACTION="cycle"
            else
              ACTION="status"
            fi
          fi
          echo "action=$ACTION" >> $GITHUB_OUTPUT

      - name: Get current status
        id: status
        run: |
          RDS_STATUS=$(aws rds describe-db-instances --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null || echo "not-found")
          echo "rds_status=$RDS_STATUS" >> $GITHUB_OUTPUT

      - name: Stop Services (save costs)
        if: steps.determine-action.outputs.action == 'stop'
        run: |
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 0
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 0
          aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} || echo "Already stopped"

      - name: Prevent RDS 7-day auto-restart
        if: steps.determine-action.outputs.action == 'cycle'
        run: |
          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            sleep 180 # 가동 준비 시간을 위해 조금 더 대기
            aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
          fi

      - name: Start Services
        if: steps.determine-action.outputs.action == 'start'
        run: |
          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
          fi
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 1
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 1
          aws ecs wait services-stable --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.FRONTEND_SERVICE }} ${{ env.BACKEND_SERVICE }}

      - name: Generate status summary
        if: always()
        run: |
          # 최종 결과 요약 리포트 생성 로직 (기존과 동일)
          echo "### 📊 Final Status Report" >> $GITHUB_STEP_SUMMARY
          # ... (이하 생략)
