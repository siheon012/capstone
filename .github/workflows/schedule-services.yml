name: â° AWS Services Scheduler (ECS + RDS)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST 08:00 = UTC ì „ë‚  23:00) - ì„œë¹„ìŠ¤ ì¤‘ì§€
    - cron: '0 23 * * *'
    # ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST 14:00 = UTC 05:00) - ì„œë¹„ìŠ¤ ì‹œìž‘
    - cron: '0 5 * * *'
    # ë§¤ì£¼ í† ìš”ì¼ ì˜¤ì „ (7ì¼ ìžë™ ì‹œìž‘ ë°©ì§€)
    - cron: '0 1 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.ECS_CLUSTER }}
  FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}
  BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}

jobs:
  schedule-ecs:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine action
        id: determine-action
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
          else
            # Cron ê¸°ë°˜ ìžë™ ì‹¤í–‰
            HOUR=$(date -u +%H)
            
            # UTC 23:00 (KST 08:00) - ì„œë¹„ìŠ¤ ì¤‘ì§€
            if [ "$HOUR" == "23" ]; then
              ACTION="stop"
            # UTC 05:00 (KST 14:00) - ì„œë¹„ìŠ¤ ì‹œìž‘
            elif [ "$HOUR" == "05" ]; then
              ACTION="start"
            else
              ACTION="status"
            fi
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Action determined: $ACTION"

      - name: Get current service status
        id: status
        run: |
          echo "ðŸ“Š Current Service Status"
          echo "========================"
          echo ""
          echo "[ECS Services]"

          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.FRONTEND_SERVICE }} \
            --query 'services[0].desiredCount' \
            --output text \
            --region ${{ env.AWS_REGION }})

          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.BACKEND_SERVICE }} \
            --query 'services[0].desiredCount' \
            --output text \
            --region ${{ env.AWS_REGION }})

          echo "Frontend: $FRONTEND_COUNT tasks"
          echo "Backend: $BACKEND_COUNT tasks"

          echo ""
          echo "[RDS Database]"

          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "not-found")

          echo "RDS Status: $RDS_STATUS"

          echo "frontend_count=$FRONTEND_COUNT" >> $GITHUB_OUTPUT
          echo "backend_count=$BACKEND_COUNT" >> $GITHUB_OUTPUT
          echo "rds_status=$RDS_STATUS" >> $GITHUB_OUTPUT

      - name: Stop ECS services (save costs)
        if: steps.determine-action.outputs.action == 'stop'
        run: |
          echo "ðŸ›‘ Stopping ECS services to save costs..."

          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.FRONTEND_SERVICE }} \
            --desired-count 0 \
            --region ${{ env.AWS_REGION }}

          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.BACKEND_SERVICE }} \
            --desired-count 0 \
            --region ${{ env.AWS_REGION }}

          echo "âœ… ECS services stopped"

      - name: Stop RDS instance
        if: steps.determine-action.outputs.action == 'stop'
        run: |
          echo "ðŸ›‘ Stopping RDS instance..."

          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "not-found")

          if [ "$RDS_STATUS" == "available" ]; then
            aws rds stop-db-instance \
              --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }}
            echo "âœ… RDS stop initiated. All data preserved on disk."
          elif [ "$RDS_STATUS" == "stopped" ]; then
            echo "â„¹ï¸ RDS already stopped"
          else
            echo "âš ï¸ RDS status: $RDS_STATUS (cannot stop)"
          fi

      - name: Prevent RDS 7-day auto-restart
        if: github.event.schedule == '0 1 * * 6'
        run: |
          echo "ðŸ”„ Weekly restart to prevent AWS 7-day limit..."

          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "not-found")

          if [ "$RDS_STATUS" == "stopped" ]; then
            # ìž ê¹ ì¼°ë‹¤ê°€ ë‹¤ì‹œ ë„ê¸°
            aws rds start-db-instance \
              --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }}
            
            echo "â³ Waiting 2 minutes for RDS to start..."
            sleep 120
            
            aws rds stop-db-instance \
              --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… RDS restart cycle complete - 7-day timer reset"
          fi

      - name: Start RDS instance
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "ðŸš€ Starting RDS instance..."

          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "not-found")

          if [ "$RDS_STATUS" == "stopped" ]; then
            aws rds start-db-instance \
              --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }}
            echo "â³ RDS starting... (will take 3-5 minutes)"
            echo "âœ… RDS start initiated. All data preserved."
          elif [ "$RDS_STATUS" == "available" ]; then
            echo "â„¹ï¸ RDS already running"
          else
            echo "âš ï¸ RDS status: $RDS_STATUS"
          fi

      - name: Wait for RDS to be available
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "â³ Waiting for RDS to become available..."
          aws rds wait db-instance-available \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --region ${{ env.AWS_REGION }} || true
          echo "âœ… RDS is now available"

      - name: Start ECS services
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "ðŸš€ Starting ECS services..."

          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.FRONTEND_SERVICE }} \
            --desired-count 1 \
            --region ${{ env.AWS_REGION }}

          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service ${{ env.BACKEND_SERVICE }} \
            --desired-count 1 \
            --region ${{ env.AWS_REGION }}

          echo "âœ… ECS services started"

      - name: Wait for ECS services to stabilize
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "â³ Waiting for ECS services to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.FRONTEND_SERVICE }} ${{ env.BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} || true

          echo "âœ… Services are stable"

      - name: Generate status summary
        if: always()
        run: |
          echo "ðŸ“Š Final Status Report" >> $GITHUB_STEP_SUMMARY
          echo "=====================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action performed:** ${{ steps.determine-action.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time (UTC):** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Time (KST):** $(TZ=Asia/Seoul date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.FRONTEND_SERVICE }} \
            --query 'services[0].desiredCount' \
            --output text \
            --region ${{ env.AWS_REGION }})

          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services ${{ env.BACKEND_SERVICE }} \
            --query 'services[0].desiredCount' \
            --output text \
            --region ${{ env.AWS_REGION }})

          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "not-found")

          echo "### ECS Services" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Desired Tasks |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $FRONTEND_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | $BACKEND_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### RDS Database" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $RDS_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_COUNT" == "0" ] && [ "$BACKEND_COUNT" == "0" ] && [ "$RDS_STATUS" == "stopped" ]; then
            echo "ðŸ’° **All services stopped - maximum cost savings!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Estimated daily savings:** ~$4-7 USD" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND_COUNT" != "0" ] && [ "$RDS_STATUS" == "available" ]; then
            echo "ðŸŸ¢ **Services running - ready for traffic**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Mixed state - check individual services**" >> $GITHUB_STEP_SUMMARY
          fi
