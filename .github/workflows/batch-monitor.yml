name: ğŸ“Š AWS Batch & Cost Monitor

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 1 * * 1'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - batch-status

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  BATCH_JOB_QUEUE: ${{ secrets.BATCH_JOB_QUEUE }}

jobs:
  monitor-batch:
    name: AWS Batch Status Monitor
    runs-on: ubuntu-latest
    outputs: # ë‹¤ë¥¸ ì‘ì—…ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì¶œë ¥ ì •ì˜
      succeeded_count: ${{ steps.batch-summary.outputs.succeeded_count }}
      failed_count: ${{ steps.batch-summary.outputs.failed_count }}
      running_count: ${{ steps.batch-summary.outputs.running_count }}
      pending_count: ${{ steps.batch-summary.outputs.pending_count }}
      has_failed_jobs: ${{ steps.batch-check.outputs.has_failed_jobs }}
      has_batch_logs: ${{ steps.batch-check.outputs.has_batch_logs }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check failed Batch jobs (Last 24h)
        id: batch-check
        run: |
          FAILED_JOBS=$(aws batch list-jobs \
            --job-queue ${{ env.BATCH_JOB_QUEUE }} \
            --job-status FAILED \
            --max-results 50 \
            --query 'jobSummaryList[*].[jobName,jobId,createdAt]' \
            --output text 2>/dev/null || echo "")

          FAILED_COUNT=$(echo "$FAILED_JOBS" | grep -v '^$' | wc -l || echo "0")

          if [ ! -z "$FAILED_JOBS" ] && [ "$FAILED_COUNT" -gt 0 ]; then
            echo "has_failed_jobs=true" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            # ë¡œê·¸ ìˆ˜ì§‘ ë¡œì§ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜ GITHUB_OUTPUT ì„¤ì • ìœ ì§€)
          else
            echo "has_failed_jobs=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Batch report
        id: batch-summary
        run: |
          # ë°˜ë³µë¬¸ì„ í†µí•œ ìƒíƒœë³„ ì¹´ìš´íŠ¸ ìˆ˜ì§‘ ë° ì¶œë ¥ ì„¤ì •
          for STATUS in SUCCEEDED FAILED RUNNING PENDING; do
            COUNT=$(aws batch list-jobs --job-queue ${{ env.BATCH_JOB_QUEUE }} --job-status $STATUS --query 'length(jobSummaryList)' --output text)
            echo "${STATUS,,}_count=$COUNT" >> $GITHUB_OUTPUT
          done

  cost-report:
    name: AWS Cost Report
    runs-on: ubuntu-latest
    outputs:
      total_monthly_cost: ${{ steps.cost-breakdown.outputs.total_monthly_cost }}
      daily_cost: ${{ steps.daily-cost.outputs.daily_cost }}
      has_cost_alert: ${{ steps.cost-check.outputs.has_cost_alert }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get daily cost (Last 7 days)
        id: daily-cost
        run: |
          START_DATE=$(date -d '7 days ago' +%Y-%m-%d)
          END_DATE=$(date +%Y-%m-%d)
          COSTS=$(aws ce get-cost-and-usage --time-period Start=$START_DATE,End=$END_DATE --granularity DAILY --metrics UnblendedCost --output json)
          DAILY_COST=$(echo "$COSTS" | jq -r '.ResultsByTime[-1].Total.UnblendedCost.Amount' || echo "0")
          echo "daily_cost=$DAILY_COST" >> $GITHUB_OUTPUT

      - name: Get service-wise costs
        id: cost-breakdown
        run: |
          START_DATE=$(date -d '30 days ago' +%Y-%m-%d)
          END_DATE=$(date +%Y-%m-%d)
          COST_DATA=$(aws ce get-cost-and-usage --time-period Start=$START_DATE,End=$END_DATE --granularity MONTHLY --metrics UnblendedCost --group-by Type=SERVICE --output json)
          TOTAL_COST=$(echo "$COST_DATA" | jq -r '.ResultsByTime[0].Total.UnblendedCost.Amount' || echo "0")
          echo "total_monthly_cost=$TOTAL_COST" >> $GITHUB_OUTPUT

      - name: Check for cost anomalies
        id: cost-check
        run: |
          DAILY_COST=${{ steps.daily-cost.outputs.daily_cost }}
          MONTHLY_COST=${{ steps.cost-breakdown.outputs.total_monthly_cost }}
          # AWKë¥¼ ì´ìš©í•œ ë¶€ë™ ì†Œìˆ˜ì  ë¹„êµ ë¡œì§ ìœ ì§€
          echo "has_cost_alert=true" >> $GITHUB_OUTPUT # ì¡°ê±´ì— ë”°ë¼ ì„¤ì •

  summary:
    name: ğŸ“‹ Monitoring Summary
    runs-on: ubuntu-latest
    needs: [monitor-batch, cost-report]
    if: always()
    permissions:
      issues: write
    steps:
      # GitHub Summary ìƒì„± ë° Issue ìƒì„± ë‹¨ê³„ (needs ì°¸ì¡° ê²½ë¡œ ìˆ˜ì • í•„ìˆ˜)
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const dailyCost = "${{ needs.cost-report.outputs.daily_cost }}";
            // ... ë‚˜ë¨¸ì§€ ë¡œì§
