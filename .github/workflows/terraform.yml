name: 'Terraform CI'

on:
  pull_request:
    branches: ['develop', 'main']

permissions:
  contents: read
  pull-requests: write # PRì— ëŒ“ê¸€ì„ ë‹¬ì•„ì•¼ í•´ì„œ ê¶Œí•œ í•„ìš”í•¨
  issues: write # GitHub Issue ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ

jobs:
  terraform:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./terraform # main.tfê°€ ìˆëŠ” í´ë” ê²½ë¡œ (ì¤‘ìš”!)

    steps:
      # 1. ë‚´ ì½”ë“œ ë‚´ë ¤ë°›ê¸°
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Terraform ì„¤ì¹˜
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0 # ì‚¬ìš© ì¤‘ì¸ ë²„ì „ê³¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶¤

      # 3. AWS ìê²© ì¦ëª… ì„¤ì • (ì•„ê¹Œ ë“±ë¡í•œ Secret ì‚¬ìš©)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 4. ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ë“¤ì—¬ì“°ê¸° ì—‰ë§ì´ë©´ ì—¬ê¸°ì„œ íƒˆë½)
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      # 5. ì´ˆê¸°í™” (S3 Backend ì—°ê²°)
      - name: Terraform Init
        id: init
        run: terraform init
        continue-on-error: true

      # 6. ë³€ê²½ ì‚¬í•­ ì˜ˆì¸¡ (Plan)
      - name: Terraform Plan
        id: plan
        env:
          TF_VAR_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          terraform plan -no-color -out=tfplan.binary 2>&1 | tee /tmp/terraform_plan_output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      # 7. Terraform Planì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
      - name: Convert Plan to Text
        if: always()
        run: |
          if [ -f tfplan.binary ]; then
            terraform show -no-color tfplan.binary > /tmp/terraform_plan_readable.txt 2>&1 || echo "Plan conversion failed" > /tmp/terraform_plan_readable.txt
          else
            echo "No plan file generated" > /tmp/terraform_plan_readable.txt
          fi

      # 8. Bedrockìœ¼ë¡œ Plan ë¶„ì„
      - name: Analyze Terraform Plan with Bedrock
        if: always()
        id: bedrock-analysis
        run: |
          pip install boto3

          python3 -c "
          import json
          import os
          import boto3

          def read_file_safe(path):
              try:
                  if os.path.exists(path):
                      with open(path, 'r', encoding='utf-8', errors='replace') as f:
                          return f.read()[:8000]  # í† í° ì œí•œ ê³ ë ¤
              except Exception as e:
                  return f'Error reading file: {str(e)}'
              return 'No log found'

          plan_output = read_file_safe('/tmp/terraform_plan_output.txt')
          plan_readable = read_file_safe('/tmp/terraform_plan_readable.txt')

          fmt_outcome = '${{ steps.fmt.outcome }}'
          init_outcome = '${{ steps.init.outcome }}'
          plan_outcome = '${{ steps.plan.outcome }}'

          # Plan ì‹¤íŒ¨ ì‹œì™€ ì„±ê³µ ì‹œ ë‹¤ë¥¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
          if plan_outcome == 'failure' or init_outcome == 'failure' or fmt_outcome == 'failure':
              prompt = f'''You are a Terraform expert. Analyze the failure and provide solutions in Korean.

          **Format Check:** {fmt_outcome}
          **Init Check:** {init_outcome}
          **Plan Check:** {plan_outcome}

          **Plan Output:**
          {plan_output}

          **Detailed Plan:**
          {plan_readable}

          Please provide:
          1. ğŸ”´ **ì‹¤íŒ¨ ì›ì¸**: ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€
          2. ğŸ’¡ **í•´ê²° ë°©ë²•**: êµ¬ì²´ì ì¸ ìˆ˜ì • ë°©ë²• (ì½”ë“œ ì˜ˆì‹œ í¬í•¨)
          3. ğŸ“Œ **ì²´í¬ë¦¬ìŠ¤íŠ¸**: í™•ì¸í•´ì•¼ í•  ì‚¬í•­ë“¤

          ë‹µë³€ì€ ëª…í™•í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          '''
          else:
              prompt = f'''You are a Terraform expert. Analyze the successful plan and summarize changes in Korean.

          **Plan Output:**
          {plan_output}

          **Detailed Plan:**
          {plan_readable}

          Please provide:
          1. ğŸ“Š **ë³€ê²½ ìš”ì•½**: 
             - ìƒì„±ë  ë¦¬ì†ŒìŠ¤ (create)
             - ìˆ˜ì •ë  ë¦¬ì†ŒìŠ¤ (update/change)
             - ì‚­ì œë  ë¦¬ì†ŒìŠ¤ (destroy) âš ï¸ **êµµê²Œ ê°•ì¡°**

          2. ğŸ’° **ë¹„ìš© ì˜í–¥**: ì˜ˆìƒë˜ëŠ” ë¹„ìš© ë³€í™”

          3. âš ï¸ **ì£¼ì˜ì‚¬í•­**: 
             - Destroyê°€ ìˆë‹¤ë©´ **ê°•ë ¥í•˜ê²Œ ê²½ê³ **
             - ì¤‘ìš”í•œ ì¸í”„ë¼ ë³€ê²½ì‚¬í•­
             - ë‹¤ìš´íƒ€ì„ ê°€ëŠ¥ì„±

          4. âœ… **ìŠ¹ì¸ ê¶Œì¥ì‚¬í•­**: ì´ ë³€ê²½ì„ ìŠ¹ì¸í•´ë„ ë˜ëŠ”ì§€ ì˜ê²¬

          ë‹µë³€ì€ ëª…í™•í•˜ê³  êµ¬ì¡°í™”ëœ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          '''

          payload = {
              'anthropic_version': 'bedrock-2023-05-31',
              'max_tokens': 3000,
              'messages': [{'role': 'user', 'content': prompt}]
          }

          try:
              client = boto3.client('bedrock-runtime', region_name='ap-northeast-2')
              response = client.invoke_model(
                  modelId='anthropic.claude-3-haiku-20240307-v1:0',
                  body=json.dumps(payload, ensure_ascii=False)
              )
              
              result = json.loads(response['body'].read())
              summary = result['content'][0]['text']
              
              with open('/tmp/bedrock_terraform_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(summary)
              print('âœ… Bedrock analysis complete.')
              
          except Exception as e:
              print(f'âŒ Bedrock failed: {str(e)}')
              with open('/tmp/bedrock_terraform_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f'AI ë¶„ì„ ì‹¤íŒ¨: {str(e)}')
          "

      # 9. GitHub Issue ìƒì„±
      - name: Create Terraform Analysis Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].substring(0, 8);
            const commit = '${{ github.sha }}'.substring(0, 7);

            let analysis = "Bedrock ë¶„ì„ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            try {
              analysis = fs.readFileSync('/tmp/bedrock_terraform_analysis.txt', 'utf8');
            } catch (e) {
              console.log("No bedrock analysis found");
            }

            let planOutput = "";
            try {
              planOutput = fs.readFileSync('/tmp/terraform_plan_output.txt', 'utf8');
            } catch (e) {
              planOutput = "Plan output not available";
            }

            const fmtStatus = '${{ steps.fmt.outcome }}';
            const initStatus = '${{ steps.init.outcome }}';
            const planStatus = '${{ steps.plan.outcome }}';
            const serverUrl = '${{ github.server_url }}';
            const repository = '${{ github.repository }}';
            const sha = '${{ github.sha }}';
            const refName = '${{ github.ref_name }}';
            const actor = '${{ github.actor }}';

            const isFailure = fmtStatus === 'failure' || initStatus === 'failure' || planStatus === 'failure';
            const emoji = isFailure ? 'ğŸš¨' : 'âœ…';
            const status = isFailure ? 'ì‹¤íŒ¨' : 'ì„±ê³µ';
            const labels = isFailure 
              ? ['terraform', 'plan-failure', 'needs-fix'] 
              : ['terraform', 'plan-success', 'review-needed'];

            const body = `## ${emoji} Terraform Plan ${status} - ${date} ${time}

            **Commit:** [\`${commit}\`](${serverUrl}/${repository}/commit/${sha})
            **Branch:** \`${refName}\`
            **Actor:** @${actor}

            ### ğŸ“‹ ì‹¤í–‰ ê²°ê³¼
            - **Format Check:** \`${fmtStatus}\`
            - **Init Check:** \`${initStatus}\`
            - **Plan Check:** \`${planStatus}\`

            ### ğŸ¤– AI ë¶„ì„ ê²°ê³¼
            ${analysis}

            <details>
            <summary>ğŸ“ Terraform Plan ì›ë³¸ ì¶œë ¥ ë³´ê¸°</summary>

            \`\`\`terraform
            ${planOutput.substring(0, 10000)}
            \`\`\`

            </details>

            ---
            *ìë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤. ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ @${actor}ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${emoji} Terraform Plan ${status} - ${date} (${commit})`,
              body: body,
              labels: labels
            });

      # 10. PRì— ëŒ“ê¸€ ë‹¬ê¸° (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
      - name: Update Pull Request
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let analysis = "Bedrock ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            try {
              analysis = fs.readFileSync('/tmp/bedrock_terraform_analysis.txt', 'utf8');
            } catch (e) {
              console.log("No bedrock analysis found");
            }

            const fmtStatus = '${{ steps.fmt.outcome }}';
            const initStatus = '${{ steps.init.outcome }}';
            const planStatus = '${{ steps.plan.outcome }}';
            const actor = '${{ github.actor }}';
            const eventName = '${{ github.event_name }}';

            const output = `#### ğŸ–Œ Terraform Format and Style ğŸ–Œ\`${fmtStatus}\`
            #### âš™ï¸ Terraform Initialization âš™ï¸\`${initStatus}\`
            #### ğŸ“– Terraform Plan ğŸ“–\`${planStatus}\`

            ### ğŸ¤– AI ë¶„ì„ ê²°ê³¼
            ${analysis}

            <details><summary>Show Raw Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pusher: @${actor}, Action: \`${eventName}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
