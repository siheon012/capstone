name: AWS Services Scheduler (ECS + RDS)

on:
  schedule:
    # 1. [STOP] ë§¤ì¼ ì˜¤ì „ 07:30 (KST 07:30 = UTC ì „ë‚  22:30)
    - cron: '45 14 * * *'

    # 2. [START] ë§¤ì¼ ì˜¤í›„ 01:30 (KST 13:30 = UTC 04:30)
    - cron: '15 9 * * *'

    # 3. [CYCLE] ë§¤ì£¼ í† ìš”ì¼ ì˜¤ì „ 10:00 (KST 10:00 = UTC 01:00)
    # (RDSê°€ 7ì¼ ì´ìƒ êº¼ì ¸ ìžˆìœ¼ë©´ AWSê°€ ê°•ì œë¡œ ì¼œë²„ë¦¬ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ìž ê¹ ì¼°ë‹¤ ë„ëŠ” ë¡œì§)
    - cron: '0 1 * * 6'

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.ECS_CLUSTER }}
  FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}
  BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}

jobs:
  schedule-ecs:
    name: Manage ECS & RDS Schedule
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸ› ï¸ [í•µì‹¬] Cron ì‹ì„ ì§ì ‘ ë¹„êµí•˜ì—¬ ì˜¤ìž‘ë™ ë°©ì§€
      - name: Determine action
        id: determine-action
        run: |
          echo "ðŸ” Analyzing trigger source..."

          # 1. ìˆ˜ë™ ì‹¤í–‰ ì²˜ë¦¬
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
            echo "ðŸ‘‰ Triggered manually. Action: $ACTION"

          # 2. ìžë™ ìŠ¤ì¼€ì¤„ ì²˜ë¦¬
          else
            SCHEDULE_CRON="${{ github.event.schedule }}"
            echo "â° Triggered by schedule cron: $SCHEDULE_CRON"
            
            # UTC 22:30 (KST 07:30) -> STOP
            if [[ "$SCHEDULE_CRON" == *"30 22"* ]]; then
              ACTION="stop"
            # UTC 04:30 (KST 13:30) -> START
            elif [[ "$SCHEDULE_CRON" == *"30 4"* ]]; then
              ACTION="start"
            # UTC 01:00 (KST 10:00) -> CYCLE
            elif [[ "$SCHEDULE_CRON" == *"0 1"* ]]; then
              ACTION="cycle"
            else
              ACTION="status"
              echo "âš ï¸ Warning: Unknown schedule pattern. Defaulting to status check."
            fi
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Final Action Determined: $ACTION"

      - name: Get current status
        id: status
        run: |
          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text 2>/dev/null || echo "not-found")

          echo "rds_status=$RDS_STATUS" >> $GITHUB_OUTPUT
          echo "Current RDS Status: $RDS_STATUS"

      # [STOP] ì„œë¹„ìŠ¤ ì¤‘ì§€ (ì˜¤ì „ 7ì‹œë°˜)
      - name: Stop Services (Save Costs)
        if: steps.determine-action.outputs.action == 'stop'
        run: |
          echo "ðŸ›‘ Stopping ECS services..."
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 0
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 0

          echo "ðŸ›‘ Stopping RDS instance..."
          if [ "${{ steps.status.outputs.rds_status }}" == "available" ]; then
            aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "âœ… RDS stop command sent."
          else
            echo "â„¹ï¸ RDS is already stopped or busy ($RDS_STATUS). Skipping."
          fi

      # [CYCLE] 7ì¼ ìžë™ ì‹œìž‘ ë°©ì§€ (í† ìš”ì¼ ì˜¤ì „ 10ì‹œ)
      - name: Prevent RDS 7-day auto-restart
        if: steps.determine-action.outputs.action == 'cycle'
        run: |
          echo "ðŸ”„ Running weekly cycle to reset 7-day timer..."
          # êº¼ì ¸ìžˆìœ¼ë©´ ì¼°ë‹¤ê°€ -> 5ë¶„ ëŒ€ê¸° -> ë‹¤ì‹œ ë”
          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "â³ RDS starting... waiting 5 minutes..."
            aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            
            echo "âœ… RDS is available. Stopping immediately."
            aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "âœ… RDS cycle complete."
          else
            echo "â„¹ï¸ RDS is not stopped. Skipping cycle."
          fi

      # [START] ì„œë¹„ìŠ¤ ì‹œìž‘ (ì˜¤í›„ 1ì‹œë°˜)
      - name: Start Services
        if: steps.determine-action.outputs.action == 'start'
        run: |
          echo "ðŸš€ Starting Services..."

          if [ "${{ steps.status.outputs.rds_status }}" == "stopped" ]; then
            aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
            echo "â³ Waiting for RDS to become available..."
            aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
          fi

          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.FRONTEND_SERVICE }} --desired-count 1
          aws ecs update-service --cluster ${{ env.CLUSTER_NAME }} --service ${{ env.BACKEND_SERVICE }} --desired-count 1

          echo "â³ Waiting for ECS services to stabilize..."
          aws ecs wait services-stable --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.FRONTEND_SERVICE }} ${{ env.BACKEND_SERVICE }}
          echo "âœ… All services started successfully."

      - name: Generate status summary
        if: always()
        run: |
          echo "### ðŸ“Š Final Status Report" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ steps.determine-action.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time (KST):** $(TZ=Asia/Seoul date)" >> $GITHUB_STEP_SUMMARY

          FRONTEND_COUNT=$(aws ecs describe-services --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.FRONTEND_SERVICE }} --query 'services[0].desiredCount' --output text)
          BACKEND_COUNT=$(aws ecs describe-services --cluster ${{ env.CLUSTER_NAME }} --services ${{ env.BACKEND_SERVICE }} --query 'services[0].desiredCount' --output text)
          RDS_STATUS=$(aws rds describe-db-instances --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null || echo "unknown")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status / Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Frontend | **$FRONTEND_COUNT** tasks |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend | **$BACKEND_COUNT** tasks |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ RDS | **$RDS_STATUS** |" >> $GITHUB_STEP_SUMMARY
