name: Terratest - Infrastructure Testing

on:
  # PRì—ì„œ terraform ë³€ê²½ ì‹œ ë¹ ë¥¸ ê²€ì¦ (Plan & Validateë§Œ)
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'test/**'

  # ì£¼ê°„ ì „ì²´ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ë¦¬ì†ŒìŠ¤ ìƒì„±)
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ (UTC) = í•œêµ­ ì‹œê°„ ì˜¤ì „ 11ì‹œ
    - cron: '0 2 * * 1'

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate # ë¹ ë¥¸ ê²€ì¦ (Plan only, ë¬´ë£Œ)
          - unit # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ì¼ë¶€ ë¦¬ì†ŒìŠ¤ ìƒì„±)
          - integration # í†µí•© í…ŒìŠ¤íŠ¸ (ì „ì²´ ì¸í”„ë¼, ë¹„ìš© ë°œìƒ)

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  GO_VERSION: '1.21'
  AWS_REGION: 'ap-northeast-2'

jobs:
  # ========================================
  # Job 1: ë¹ ë¥¸ ê²€ì¦ (ë¬´ë£Œ, PRë§ˆë‹¤ ì‹¤í–‰)
  # ========================================
  validate:
    name: ðŸ” Terraform Validation Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # cache disabled until go.sum is committed

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test/infra
        run: |
          go mod download
          go mod tidy

      - name: Run Validation Tests
        working-directory: test/infra
        run: |
          echo "ðŸ” Running fast validation tests (no AWS resources created)..."

          # í¬ë§· ê²€ì‚¬
          go test -v -run TestTerraformFormatting -timeout 5m

          # Terraform validate
          go test -v -run TestTerraformValidation -timeout 10m

          # Plan í…ŒìŠ¤íŠ¸ (ë¦¬ì†ŒìŠ¤ ìƒì„± ì•ˆ í•¨)
          go test -v -run TestNetworkModulePlan -timeout 5m
          go test -v -run TestStorageModulePlan -timeout 5m
          go test -v -run TestSecurityModulePlan -timeout 5m

      - name: Comment PR with validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Terratest Validation Passed
              
              All Terraform modules passed validation tests:
              - âœ… Format check
              - âœ… Syntax validation
              - âœ… Plan generation
              
              No AWS resources were created during this test.
              `
            });

  # ========================================
  # Job 2: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë¹„ìš© ë°œìƒ, ì£¼ê°„ ì‹¤í–‰)
  # ========================================
  unit-tests:
    name: ðŸ§ª Unit Tests (AWS Resources)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'unit')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # cache disabled until go.sum is committed

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test/infra
        run: |
          go mod download
          go mod tidy

      - name: Run Network Module Tests
        working-directory: test/infra
        run: |
          echo "ðŸŒ Testing Network Module (creates VPC, subnets)..."
          go test -v -run TestNetworkModule -timeout 30m

      - name: Run Storage Module Tests
        working-directory: test/infra
        run: |
          echo "ðŸ—„ï¸ Testing Storage Module (creates S3 buckets)..."
          go test -v -run TestStorageModule -timeout 30m

      - name: Run Security Module Tests
        working-directory: test/infra
        run: |
          echo "ðŸ” Testing Security Module (creates IAM roles)..."
          go test -v -run TestIAMRoleCreation -timeout 30m

      - name: Generate test report
        if: always()
        run: |
          echo "## ðŸ§ª Terratest Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Network | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ These tests created actual AWS resources that were automatically cleaned up." >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Job 3: í†µí•© í…ŒìŠ¤íŠ¸ (ë¹„ìš© ë§Žì´ ë°œìƒ, ìˆ˜ë™ ì‹¤í–‰ë§Œ)
  # ========================================
  integration-tests:
    name: ðŸš€ Integration Tests (Full Stack)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.test_type == 'integration'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          # cache disabled until go.sum is committed

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test/infra
        run: |
          go mod download
          go mod tidy

      - name: âš ï¸ Confirm Integration Test
        run: |
          echo "================================================"
          echo "âš ï¸ WARNING: FULL INTEGRATION TEST"
          echo "================================================"
          echo "This will:"
          echo "- Create complete infrastructure stack"
          echo "- Take 15-20 minutes"
          echo "- Cost approximately $1-2"
          echo "- Automatically cleanup all resources"
          echo "================================================"

      - name: Run Full Integration Tests
        working-directory: test/infra
        run: |
          echo "ðŸš€ Running full integration test..."
          go test -v -run TestCompleteInfrastructure -timeout 60m

      - name: Test Idempotency
        working-directory: test/infra
        run: |
          echo "ðŸ”„ Testing infrastructure idempotency..."
          go test -v -run TestInfrastructurePlanNoChanges -timeout 60m

      - name: Create Issue with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const status = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${status} Integration Test - ${date}`,
              body: `## ðŸš€ Full Infrastructure Integration Test Results
              
              **Date:** ${date}
              **Status:** ${status}
              **Duration:** ~15-20 minutes
              **Cost:** ~$1-2
              
              ### Tests Run:
              - âœ… Complete infrastructure deployment
              - âœ… Idempotency verification
              - âœ… Resource cleanup
              
              ### Details:
              See workflow run: ${context.payload.repository.html_url}/actions/runs/${context.runId}
              
              ---
              *Automated integration test report*
              `,
              labels: ['terratest', 'integration-test', 'infrastructure']
            });

  # ========================================
  # Job 4: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  # ========================================
  summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [validate, unit-tests, integration-tests]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§ª Terratest Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Integration | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Test Types:" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation**: Fast, free, runs on every PR" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: Creates individual modules, weekly schedule" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration**: Full stack, manual trigger only" >> $GITHUB_STEP_SUMMARY
